<!DOCTYPE html>
<html lang="zh-CN" class="theme-dark"> <!-- Default to dark theme -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>摩托车成本模型</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            /* Color Palette & Accent */
            --hue-accent: 210; --saturation-accent: 100%; --lightness-accent: 50%;
            --color-accent: hsl(var(--hue-accent), var(--saturation-accent), var(--lightness-accent));
            --color-accent-hover: hsl(var(--hue-accent), var(--saturation-accent), calc(var(--lightness-accent) + 10%));
            --color-accent-active: hsl(var(--hue-accent), var(--saturation-accent), calc(var(--lightness-accent) - 5%));
            
            /* Typography -- UPDATED FONT SIZES */
            --font-family-sans: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-size-base: 15px; 
            --font-size-sm: 13px; 
            --font-size-lg: 24px; 
            --font-size-xl: 25px; 
            --font-size-xxl: 35px; 
            --font-size-display: 48px; 
            --font-size-chart-xaxis: 16px; /* Unified font size for X-axis and data labels */

            /* Weights, Spacing, Radius, Shadows, Transitions (mostly same as before) */
            --font-weight-light: 300; --font-weight-regular: 400; --font-weight-medium: 500; --font-weight-semibold: 600; --font-weight-bold: 700;
            --spacing-xs: 4px; --spacing-sm: 8px; --spacing-md: 16px; --spacing-lg: 24px; --spacing-xl: 32px; --spacing-xxl: 48px;
            --border-radius: 12px; --border-radius-lg: 18px;
            --shadow-subtle: 0 2px 8px rgba(0,0,0,0.2); --shadow-strong: 0 8px 24px rgba(0,0,0,0.3);
            --transition-duration-fast: 0.2s; --transition-duration-normal: 0.35s; --transition-timing-function: cubic-bezier(0.65, 0, 0.35, 1);
        }

        /* --- Dark Theme --- */
        html.theme-dark {
            --color-background-page: #000000;
            --color-background-content: #1c1c1e;
            --color-background-elevated: #2c2c2e;
            --color-background-input: #121214;
            --color-text-primary: #f5f5f7;
            --color-text-secondary: #d1d1d6;
            --color-text-tertiary: #a1a1a6;
            --color-border: #48484a;
            --color-divider: #3a3a3c;
            --color-negative: #ff453a;
            --color-positive: #32d74b;
            --color-warning: #ffcc00;
            --color-neutral: #8e8e93;
            --color-text-primary-rgb: 245,245,247;
            --color-header-bg: rgba(20, 20, 22, 0.75);
            color-scheme: dark;
        }

        /* --- Light Theme --- */
        html.theme-light {
            --color-background-page: #f2f2f7;
            --color-background-content: #ffffff;
            --color-background-elevated: #ffffff;
            --color-background-input: #eef0f2;
            --color-text-primary: #1d1d1f;
            --color-text-secondary: #555558;
            --color-text-tertiary: #8a8a8e;
            --color-border: #d1d1d6;
            --color-divider: #e5e5ea;
            --color-negative: #d70015;
            --color-positive: #228435;
            --color-warning: #b99000;
            --color-neutral: #6e6e73;
            --color-text-primary-rgb: 29,29,31;
            --color-header-bg: rgba(242, 242, 247, 0.75);
            color-scheme: light;
        }

        /* General, App Structure, Theme Toggle (mostly same) */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family-sans); background-color: var(--color-background-page); color: var(--color-text-primary);
            font-size: var(--font-size-base); line-height: 1.5; min-height: 100vh;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden; display: flex; flex-direction: column;
            transition: background-color var(--transition-duration-normal), color var(--transition-duration-normal);
        }
        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        .app-header-sticky {
            position: sticky; top: 0; z-index: 1000; background-color: var(--color-header-bg);
            backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--color-border);
            transition: background-color var(--transition-duration-normal), border-color var(--transition-duration-normal);
        }
        .app-header {
            max-width: 1440px; margin: 0 auto; padding: var(--spacing-md) var(--spacing-lg);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);
        }
        .app-title { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: var(--color-text-primary); }
        .app-controls { display: flex; gap: var(--spacing-sm); align-items: center; }
        .theme-toggle-btn {
            background: transparent; border: none; cursor: pointer; padding: var(--spacing-xs);
            color: var(--color-text-secondary); display: flex; align-items: center; justify-content: center;
        }
        .theme-toggle-btn:hover { color: var(--color-accent); }
        .theme-toggle-btn svg { width: 20px; height: 20px; }
        .theme-toggle-btn .icon-sun { display: none; } .theme-toggle-btn .icon-moon { display: block; }
        html.theme-light .theme-toggle-btn .icon-sun { display: block; } html.theme-light .theme-toggle-btn .icon-moon { display: none; }

        /* Main View & KPI Zone (mostly same) */
        .main-view {
            flex-grow: 1; max-width: 1440px; width: 100%; margin: 0 auto;
            padding: var(--spacing-xl) var(--spacing-lg); display: flex; flex-direction: column; gap: var(--spacing-xl);
        }
        .kpi-zone { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--spacing-lg); }
        .kpi-card {
            background-color: var(--color-background-content); border-radius: var(--border-radius-lg); padding: var(--spacing-lg);
            box-shadow: var(--shadow-subtle); text-align: center;
            transition: background-color var(--transition-duration-normal), box-shadow var(--transition-duration-normal);
        }
        .kpi-card__label { font-size: var(--font-size-base); color: var(--color-text-secondary); margin-bottom: var(--spacing-sm); font-weight: var(--font-weight-medium); }
        .kpi-card__value { font-size: var(--font-size-display); font-weight: var(--font-weight-bold); color: var(--color-text-primary); line-height: 1.1; }
        .kpi-card__value .unit { font-size: var(--font-size-lg); font-weight: var(--font-weight-medium); color: var(--color-text-secondary); margin-left: var(--spacing-xs); }
        .kpi-card__value.is-positive { color: var(--color-positive); }
        .kpi-card__value.is-negative { color: var(--color-negative); }
        .kpi-card__value.is-warning { color: var(--color-warning); }

        /* Analysis Zone with Tabs (Tabs same, content structure changes) */
        .analysis-zone { display: flex; flex-direction: column; gap: var(--spacing-md); }
        .analysis-tabs {
            display: flex; gap: var(--spacing-xs); margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-sm); border-bottom: 1px solid var(--color-border);
            transition: border-color var(--transition-duration-normal); flex-wrap: wrap;
        }
        .analysis-tab-btn {
            padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-base); font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary); background-color: transparent; border: none;
            border-bottom: 3px solid transparent; cursor: pointer;
            transition: color var(--transition-duration-fast), border-color var(--transition-duration-fast);
        }
        .analysis-tab-btn:hover { color: var(--color-text-primary); }
        .analysis-tab-btn.is-active { color: var(--color-accent); border-bottom-color: var(--color-accent); }
        .analysis-content { display: none; }
        .analysis-content.is-active { display: flex; flex-direction: column; gap: var(--spacing-lg); }

        /* Chart Layout: Each chart takes full width, stacked vertically */
        .chart-card {
            background: var(--color-background-content); border-radius: var(--border-radius-lg);
            padding: var(--spacing-md);
            min-height: 400px; /* Increased min-height due to larger fonts */
            box-shadow: var(--shadow-subtle); display: flex; flex-direction: column;
            transition: background-color var(--transition-duration-normal), box-shadow var(--transition-duration-normal);
            width: 100%;
        }
        .chart-instance { width: 100%; height: 100%; flex-grow: 1; }

        /* Parameters Drawer, Form Fields, Buttons, Modal & Backdrop (mostly same) */
        .parameters-drawer {
            position: fixed; top: 0; right: 0; width: 380px; /* Slightly wider for larger fonts */
            height: 100%;
            background-color: var(--color-background-elevated); box-shadow: var(--shadow-strong);
            padding-top: 0; overflow-y: hidden; z-index: 1100; transform: translateX(100%);
            transition: transform var(--transition-duration-normal) var(--transition-timing-function),
                        background-color var(--transition-duration-normal), box-shadow var(--transition-duration-normal);
            display: flex; flex-direction: column;
        }
        .parameters-drawer.is-open { transform: translateX(0); }
        .parameters-drawer__header {
            display: flex; justify-content: space-between; align-items: center;
            padding: var(--spacing-md) var(--spacing-lg); border-bottom: 1px solid var(--color-border);
            background-color: var(--color-background-elevated); position: sticky; top: 0; z-index: 1;
            transition: border-color var(--transition-duration-normal), background-color var(--transition-duration-normal);
        }
        .parameters-drawer__title { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); }
        .parameters-drawer__content { flex-grow: 1; overflow-y: auto; padding: var(--spacing-lg); padding-top: var(--spacing-md); }
        .parameters-drawer__content::-webkit-scrollbar { width: 8px; }
        .parameters-drawer__content::-webkit-scrollbar-track { background: transparent; }
        .parameters-drawer__content::-webkit-scrollbar-thumb { background-color: var(--color-text-tertiary); border-radius: 4px; }
        .input-group { margin-bottom: var(--spacing-lg); }
        .input-group__title { font-size: var(--font-size-base); color: var(--color-accent); margin-bottom: var(--spacing-md); font-weight: var(--font-weight-semibold); }
        .form-field { margin-bottom: var(--spacing-md); position: relative; }
        .form-field__label { font-size: var(--font-size-sm); color: var(--color-text-secondary); display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm); font-weight: var(--font-weight-regular); }
        .form-field__default-value { font-size: calc(var(--font-size-sm) - 2px); /* Adjusted for base font change */ color: var(--color-text-tertiary); }
        .form-field__input {
            width: 100%; padding: var(--spacing-md) var(--spacing-lg) var(--spacing-md) var(--spacing-md); /* Increased padding for larger font */
            border: 1px solid var(--color-border); border-radius: var(--border-radius);
            font-size: var(--font-size-base); color: var(--color-text-primary);
            background-color: var(--color-background-input);
            transition: border-color var(--transition-duration-fast), box-shadow var(--transition-duration-fast), background-color var(--transition-duration-fast);
        }
        .form-field__input:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 3px hsla(var(--hue-accent), var(--saturation-accent), var(--lightness-accent), 0.3); }
        .form-field__input[type=number]::-webkit-inner-spin-button, .form-field__input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .form-field__input[type=number] { -moz-appearance: textfield; }
        .form-field__unit { position: absolute; right: var(--spacing-md); /* Adjusted for increased input padding */ top: calc(50% + var(--spacing-sm)); transform: translateY(-50%); color: var(--color-text-tertiary); font-size: var(--font-size-sm); }
        .form-field__input--highlight { border-color: var(--color-accent) !important; animation: pulse-border 1.5s ease-out; }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 hsla(var(--hue-accent), var(--saturation-accent), var(--lightness-accent), 0.4); }
            70% { box-shadow: 0 0 0 8px hsla(var(--hue-accent), var(--saturation-accent), var(--lightness-accent), 0); }
            100% { box-shadow: 0 0 0 0 hsla(var(--hue-accent), var(--saturation-accent), var(--lightness-accent), 0); }
        }
        .btn {
            padding: var(--spacing-md) var(--spacing-lg); /* Increased padding for buttons */
            border: 1px solid transparent;
            background-color: hsla(var(--color-text-primary-rgb-tuple, 0,0,0), 0.1); 
            border-radius: var(--border-radius); cursor: pointer;
            font-size: var(--font-size-base); /* Buttons use base font size now */
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            transition: background-color var(--transition-duration-fast), transform var(--transition-duration-fast), color var(--transition-duration-fast), border-color var(--transition-duration-fast);
            display: inline-flex; align-items: center; gap: var(--spacing-sm); line-height: 1.2;
        }
        html.theme-dark .btn { --color-text-primary-rgb-tuple: var(--color-text-primary-rgb); }
        html.theme-light .btn { --color-text-primary-rgb-tuple: var(--color-text-primary-rgb); }
        .btn:hover { background-color: hsla(var(--color-text-primary-rgb-tuple), 0.15); transform: translateY(-1px); }
        .btn:active { transform: translateY(0px); background-color: hsla(var(--color-text-primary-rgb-tuple), 0.1); }
        .btn:focus-visible { outline: 2px solid var(--color-accent); outline-offset: 2px; }
        .btn svg { width: var(--font-size-base); height: var(--font-size-base); fill: currentColor; } /* SVG size matches font */
        .btn--primary { background-color: var(--color-accent); color: #fff !important; }
        .btn--primary:hover { background-color: var(--color-accent-hover); }
        .btn--primary:active { background-color: var(--color-accent-active); }
        .btn--icon { background-color: transparent; padding: var(--spacing-sm); color: var(--color-text-secondary); }
        .btn--icon:hover { background-color: hsla(var(--color-text-primary-rgb-tuple), 0.1); color: var(--color-text-primary); }
        .btn-group .btn { border-radius: 0; background-color: var(--color-background-elevated); border: 1px solid var(--color-border); margin-left: -1px; }
        .btn-group .btn:hover { background-color: var(--color-background-content); }
        .btn-group .btn:first-child { border-top-left-radius: var(--border-radius); border-bottom-left-radius: var(--border-radius); margin-left: 0;}
        .btn-group .btn:last-child { border-top-right-radius: var(--border-radius); border-bottom-right-radius: var(--border-radius); }
        .btn-group .btn.is-active { background-color: var(--color-accent); color: #fff !important; border-color: var(--color-accent); z-index: 1; }
        .btn-group .btn.is-active:hover { background-color: var(--color-accent-hover); border-color: var(--color-accent-hover); }
        .drawer-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); opacity: 0; visibility: hidden; z-index: 1090;
            transition: opacity var(--transition-duration-normal) var(--transition-timing-function), visibility var(--transition-duration-normal) var(--transition-timing-function);
        }
        .drawer-backdrop.is-visible { opacity: 1; visibility: visible; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 2000; opacity: 0; transition: opacity var(--transition-duration-normal); align-items: center; justify-content: center; padding: var(--spacing-md); }
        .modal.is-visible { display: flex; opacity: 1; }
        .modal__content { background-color: var(--color-background-elevated); border-radius: var(--border-radius-lg); padding: var(--spacing-lg); width: 90%; max-width: 680px; max-height: 85vh; overflow-y: auto; box-shadow: var(--shadow-strong); transform: scale(0.95) translateY(20px); transition: transform var(--transition-duration-normal) var(--transition-timing-function), opacity var(--transition-duration-normal) var(--transition-timing-function), background-color var(--transition-duration-normal); }
        .modal.is-visible .modal__content { transform: scale(1) translateY(0); opacity: 1; }
        .modal__content::-webkit-scrollbar { width: 8px; } .modal__content::-webkit-scrollbar-track { background: transparent; } .modal__content::-webkit-scrollbar-thumb { background-color: var(--color-text-tertiary); border-radius: 4px; }
        .modal__header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--color-border); transition: border-color var(--transition-duration-normal); }
        .modal__title { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); }
        .indicator-info-group { margin-bottom: var(--spacing-lg); } .indicator-info-group__title { font-size: var(--font-size-base); color: var(--color-accent); margin-bottom: var(--spacing-md); font-weight: var(--font-weight-semibold); }
        .indicator-info-item { margin-bottom: var(--spacing-md); padding-left: var(--spacing-md); border-left: 2px solid var(--color-border); transition: border-color var(--transition-duration-normal); }
        .indicator-info-item__name { font-size: var(--font-size-base); color: var(--color-text-primary); margin-bottom: var(--spacing-xs); font-weight: var(--font-weight-medium); }
        .indicator-info-item__description { font-size: var(--font-size-sm); color: var(--color-text-secondary); line-height: 1.6; }

        /* Responsive */
        @media (max-width: 768px) {
            .app-header { flex-direction: column; align-items: flex-start; }
            .app-controls { width: 100%; flex-wrap: wrap; justify-content: flex-start; }
            .btn-group { flex-grow: 1; }
            .parameters-drawer { width: 90%; max-width: 340px; } /* Slightly adjust for mobile */
            .kpi-card__value { font-size: var(--font-size-xxl); }
            .kpi-card__value .unit { font-size: var(--font-size-base); }
            .main-view { padding: var(--spacing-lg) var(--spacing-md); }
            .analysis-tabs { justify-content: center; }
            :root { --font-size-chart-xaxis: 16px; } /* Adjust chart fonts on mobile if base is too large */
        }

    </style>
</head>
<body>
    <!-- HTML Structure (remains largely the same) -->
    <div class="app-container">
        <div class="app-header-sticky">
            <header class="app-header">
                <h1 class="app-title">摩托车成本模型</h1>
                <div class="app-controls">
                     <button class="theme-toggle-btn" id="themeToggleBtn" title="切换颜色模式">
                        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                    <div class="btn-group" id="schemeSelector">
                        <button class="btn" data-scheme="150" title="赔付率150%方案">方案A</button>
                        <button class="btn" data-scheme="135" title="赔付率135%方案">方案B</button>
                        <button class="btn" data-scheme="120.8" title="赔付率120.8%方案">方案C</button>
                        <button class="btn" data-scheme="110" title="赔付率110%方案">方案D</button>
                    </div>
                    <button class="btn" id="exportDataBtn" title="导出当前测算数据">
                        <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>导出
                    </button>
                    <button class="btn" id="showHelpBtn" title="查看计算公式说明">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>帮助
                    </button>
                    <button class="btn btn--primary" id="openParametersBtn" title="调整测算参数">
                         <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>参数
                    </button>
                </div>
            </header>
        </div>
        <main class="main-view">
            <section class="kpi-zone">
                <div class="kpi-card"><div class="kpi-card__label">总利润</div><div class="kpi-card__value" id="kpiTotalProfit">0<span class="unit">万元</span></div></div>
                <div class="kpi-card"><div class="kpi-card__label">综合成本率</div><div class="kpi-card__value" id="kpiTotalCostRate">0<span class="unit">%</span></div></div>
                <div class="kpi-card"><div class="kpi-card__label">总保费</div><div class="kpi-card__value" id="kpiTotalPremium">0<span class="unit">万元</span></div></div>
                <div class="kpi-card"><div class="kpi-card__label">边际贡献额</div><div class="kpi-card__value" id="kpiTotalEdgeContribution">0<span class="unit">万元</span></div></div>
            </section>

            <section class="analysis-zone">
                <div class="analysis-tabs" id="analysisTabsContainer">
                    <button class="analysis-tab-btn is-active" data-tab="combined">车+摩意整体</button>
                    <button class="analysis-tab-btn" data-tab="car">车险专项</button>
                    <button class="analysis-tab-btn" data-tab="moto">摩意险专项</button>
                </div>

                <div id="analysisContentCombined" class="analysis-content is-active">
                    <div class="chart-card"><div id="combinedAbsoluteChart" class="chart-instance"></div></div>
                    <div class="chart-card"><div id="combinedRateChart" class="chart-instance"></div></div>
                </div>
                <div id="analysisContentCar" class="analysis-content">
                    <div class="chart-card"><div id="carAbsoluteChart" class="chart-instance"></div></div>
                    <div class="chart-card"><div id="carRateChart" class="chart-instance"></div></div>
                </div>
                <div id="analysisContentMoto" class="analysis-content">
                    <div class="chart-card"><div id="motoAbsoluteChart" class="chart-instance"></div></div>
                    <div class="chart-card"><div id="motoRateChart" class="chart-instance"></div></div>
                </div>
            </section>
        </main>
    </div>

    <div class="drawer-backdrop" id="drawerBackdrop"></div>
    <aside class="parameters-drawer" id="parametersDrawer">
        <header class="parameters-drawer__header">
            <h2 class="parameters-drawer__title">测算参数配置</h2>
            <button class="btn btn--icon" id="closeParametersBtn" aria-label="关闭参数面板">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </header>
        <div class="parameters-drawer__content">
             <div class="input-group"><h3 class="input-group__title">基础参数</h3><div class="form-field"><label for="laborBaseRate" class="form-field__label"><span>人力成本基数</span><span class="form-field__default-value">默认: 2.8%</span></label><input type="number" id="laborBaseRate" class="form-field__input" value="2.8" step="0.1"><span class="form-field__unit">%</span></div><div class="form-field"><label for="fixedOperationRate" class="form-field__label"><span>固定运营成本率</span><span class="form-field__default-value">默认: 6%</span></label><input type="number" id="fixedOperationRate" class="form-field__input" value="6" step="0.1"><span class="form-field__unit">%</span></div></div>
             <div class="input-group"><h3 class="input-group__title">车险参数</h3><div class="form-field"><label for="carPremium" class="form-field__label"><span>车险保费</span><span class="form-field__default-value">默认: 1000</span></label><input type="number" id="carPremium" class="form-field__input" value="1000" step="100"><span class="form-field__unit">万元</span></div><div class="form-field"><label for="carLossRatio" class="form-field__label"><span>赔付率</span><span class="form-field__default-value">默认: 130%</span></label><input type="number" id="carLossRatio" class="form-field__input" value="130" step="0.1"><span class="form-field__unit">%</span></div><div class="form-field"><label for="carHandlingFeeRate" class="form-field__label"><span>手续费率</span><span class="form-field__default-value">默认: 0%</span></label><input type="number" id="carHandlingFeeRate" class="form-field__input" value="0" step="0.1"><span class="form-field__unit">%</span></div><div class="form-field"><label for="carSalesPromotionRate" class="form-field__label"><span>销推费用率</span><span class="form-field__default-value">默认: 0.3%</span></label><input type="number" id="carSalesPromotionRate" class="form-field__input" value="0.3" step="0.1"><span class="form-field__unit">%</span></div><div class="form-field"><label for="carStandardPremiumRatio" class="form-field__label"><span>标保系数</span><span class="form-field__default-value">默认: 0.5</span></label><input type="number" id="carStandardPremiumRatio" class="form-field__input" value="0.5" step="0.1"></div></div>
             <div class="input-group"><h3 class="input-group__title">摩意险参数</h3><div class="form-field"><label for="motoPremiumRatio" class="form-field__label"><span>保费配比</span><span class="form-field__default-value">默认: 1.75</span></label><input type="number" id="motoPremiumRatio" class="form-field__input" value="1.75" step="0.01"><span class="form-field__unit">倍</span></div><div class="form-field"><label for="motoLossRatio" class="form-field__label"><span>赔付率</span><span class="form-field__default-value">默认: 2.4%</span></label><input type="number" id="motoLossRatio" class="form-field__input" value="2.4" step="0.1"><span class="form-field__unit">%</span></div><div class="form-field"><label for="motoHandlingFeeRate" class="form-field__label"><span>保单获取成本率</span><span class="form-field__default-value">默认: 66.1%</span></label><input type="number" id="motoHandlingFeeRate" class="form-field__input" value="66.1" step="0.1"><span class="form-field__unit">%</span></div><div class="form-field"><label for="motoSalesPromotionRate" class="form-field__label"><span>销售推动费用率</span><span class="form-field__default-value">默认: 0.9%</span></label><input type="number" id="motoSalesPromotionRate" class="form-field__input" value="0.9" step="0.1"><span class="form-field__unit">%</span></div><div class="form-field"><label for="motoStandardPremiumRatio" class="form-field__label"><span>标保系数</span><span class="form-field__default-value">默认: 1.8</span></label><input type="number" id="motoStandardPremiumRatio" class="form-field__input" value="1.8" step="0.1"></div></div>
        </div>
    </aside>

    <div class="modal" id="indicatorHelpModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal__content">
            <header class="modal__header"><h2 class="modal__title" id="modalTitle">计算公式说明</h2><button class="btn btn--icon modal__close-btn" id="closeHelpModalBtn" aria-label="关闭"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></header>
            <div class="modal__body">
                <!-- Indicator help content (same as before) -->
                <div class="indicator-info-group"><h3 class="indicator-info-group__title">固定参数</h3><div class="indicator-info-item"><h4 class="indicator-info-item__name">固定运营成本率</h4><p class="indicator-info-item__description">固定值：6%（0.06）。用于计算固定运营成本。</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">人力成本系数</h4><p class="indicator-info-item__description">固定值：2.8%（0.028）。用于计算人力成本，与标保系数配合使用。</p></div></div>
                <div class="indicator-info-group"><h3 class="indicator-info-group__title">车险计算公式</h3><div class="indicator-info-item"><h4 class="indicator-info-item__name">赔款</h4><p class="indicator-info-item__description">公式：车险保费 × 赔付率</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">手续费</h4><p class="indicator-info-item__description">公式：车险保费 × 手续费率</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">销推费用</h4><p class="indicator-info-item__description">公式：车险保费 × 销推费用率</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">人力成本</h4><p class="indicator-info-item__description">公式：车险保费 × 标保系数 × 人力成本基数</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">变动成本率</h4><p class="indicator-info-item__description">公式：赔付率 + 手续费率 + 销推费用率 + 人力成本率 (人力成本率 = 标保系数 × 人力成本基数)</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">综合成本率</h4><p class="indicator-info-item__description">公式：变动成本率 + 固定运营成本率</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">边际贡献额</h4><p class="indicator-info-item__description">公式：车险保费 × (1 - 变动成本率)</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">利润</h4><p class="indicator-info-item__description">公式：车险保费 × (1 - 综合成本率)</p></div></div>
                <div class="indicator-info-group"><h3 class="indicator-info-group__title">摩意险计算公式</h3><div class="indicator-info-item"><h4 class="indicator-info-item__name">保费</h4><p class="indicator-info-item__description">公式：车险保费 × 保费配比</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">赔款</h4><p class="indicator-info-item__description">公式：摩意险保费 × 赔付率</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">手续费</h4><p class="indicator-info-item__description">公式：摩意险保费 × 手续费率</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">销推费用</h4><p class="indicator-info-item__description">公式：摩意险保费 × 销推费用率</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">人力成本</h4><p class="indicator-info-item__description">公式：摩意险保费 × 标保系数 × 人力成本基数</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">变动成本率</h4><p class="indicator-info-item__description">公式：赔付率 + 手续费率 + 销推费用率 + 人力成本率 (人力成本率 = 标保系数 × 人力成本基数)</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">综合成本率</h4><p class="indicator-info-item__description">公式：变动成本率 + 固定运营成本率</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">边际贡献额</h4><p class="indicator-info-item__description">公式：摩意险保费 × (1 - 变动成本率)</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">利润</h4><p class="indicator-info-item__description">公式：摩意险保费 × (1 - 综合成本率)</p></div></div>
                <div class="indicator-info-group"><h3 class="indicator-info-group__title">综合计算公式</h3><div class="indicator-info-item"><h4 class="indicator-info-item__name">总保费</h4><p class="indicator-info-item__description">公式：车险保费 + 摩意险保费</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">总赔款</h4><p class="indicator-info-item__description">公式：车险赔款 + 摩意险赔款</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">总手续费</h4><p class="indicator-info-item__description">公式：车险手续费 + 摩意险手续费</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">总销推费用</h4><p class="indicator-info-item__description">公式：车险销推费用 + 摩意险销推费用</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">总人力成本</h4><p class="indicator-info-item__description">公式：车险人力成本 + 摩意险人力成本</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">变动成本率</h4><p class="indicator-info-item__description">公式：(总赔款 + 总手续费 + 总销推费用 + 总人力成本) ÷ 总保费</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">综合成本率</h4><p class="indicator-info-item__description">公式：变动成本率 + 固定运营成本率</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">总边际贡献额</h4><p class="indicator-info-item__description">公式：总保费 × (1 - 变动成本率)</p></div><div class="indicator-info-item"><h4 class="indicator-info-item__name">总利润</h4><p class="indicator-info-item__description">公式：总保费 × (1 - 综合成本率)</p></div></div>
            </div>
        </div>
    </div>

    <script>
    // --- CostInsightPro Application Module ---
    const CostInsightPro = (() => {
        const DOMElements = {}; 
        const EChartsInstances = {};
        let currentInputValues = {};
        const DEFAULT_SCHEME_KEY = '120.8';
        const DEFAULT_ANALYSIS_TAB = 'combined';
        const APP_CONFIG = {
            THEME_STORAGE_KEY: 'costInsightProTheme',
            INDICATOR_CONFIG: { // UPDATED LABELS
                PREMIUM: { label: '保费', colorKey: 'neutral', isRate: false },
                LOSS: { label: '赔款', colorKey: 'neutral', isRate: false },
                HANDLING_FEE: { label: '手续费', colorKey: 'neutral', isRate: false },
                SALES_PROMOTION: { label: '销推费用', colorKey: 'neutral', isRate: false },
                LABOR_COST: { label: '人力成本', colorKey: 'neutral', isRate: false },
                EDGE_CONTRIBUTION: { label: '边际贡献额', colorKey: 'conditional', isRate: false, positiveGood: true },
                PROFIT: { label: '利润', colorKey: 'conditional', isRate: false, positiveGood: true },
                TCR: { label: '综合成本率', colorKey: 'conditional', isRate: true, threshold: 1, higherIsWorse: true },
                VCR: { label: '变动成本率', colorKey: 'conditional', isRate: true, threshold: 0.9, higherIsWorse: true },
                LOSS_RATIO: { label: '赔付率', colorKey: 'neutral', isRate: true },
                HANDLING_FEE_RATIO: { label: '手续费率', colorKey: 'neutral', isRate: true },
                SALES_PROMOTION_RATIO: { label: '销推费用率', colorKey: 'neutral', isRate: true },
                LABOR_COST_RATIO: { label: '人力成本率', colorKey: 'neutral', isRate: true },
                EDGE_CONTRIBUTION_RATIO: { label: '边际贡献率', colorKey: 'conditional', isRate: true, positiveGood: true }
            },
            ABSOLUTE_CHART_INDICATORS: ['PREMIUM', 'LOSS', 'HANDLING_FEE', 'SALES_PROMOTION', 'LABOR_COST', 'EDGE_CONTRIBUTION', 'PROFIT'],
            RATE_CHART_INDICATORS: ['TCR', 'VCR', 'LOSS_RATIO', 'HANDLING_FEE_RATIO', 'SALES_PROMOTION_RATIO', 'LABOR_COST_RATIO', 'EDGE_CONTRIBUTION_RATIO'],
            SCHEMES: { /* Same as before */ 
                '150': { name: '方案A', params: { laborBaseRate: 2.8, fixedOperationRate: 7.21, carPremium: 1200, carLossRatio: 150, carHandlingFeeRate: 0, carSalesPromotionRate: 0.15, carStandardPremiumRatio: 0.5, motoPremiumRatio: 1.75, motoLossRatio: 4, motoHandlingFeeRate: 66.1, motoSalesPromotionRate: 0.74, motoStandardPremiumRatio: 1.8 }},
                '135': { name: '方案B', params: { laborBaseRate: 2.8, fixedOperationRate: 7.21, carPremium: 1200, carLossRatio: 135, carHandlingFeeRate: 0, carSalesPromotionRate: 0.15, carStandardPremiumRatio: 0.5, motoPremiumRatio: 1.75, motoLossRatio: 4, motoHandlingFeeRate: 66.1, motoSalesPromotionRate: 0.74, motoStandardPremiumRatio: 1.8 }},
                '120.8': { name: '方案C (保本)', params: { laborBaseRate: 2.8, fixedOperationRate: 7.21, carPremium: 1200, carLossRatio: 120.8, carHandlingFeeRate: 0, carSalesPromotionRate: 0.15, carStandardPremiumRatio: 0.5, motoPremiumRatio: 1.75, motoLossRatio: 4, motoHandlingFeeRate: 66.1, motoSalesPromotionRate: 0.74, motoStandardPremiumRatio: 1.8 }},
                '110': { name: '方案D', params: { laborBaseRate: 2.8, fixedOperationRate: 7.21, carPremium: 1200, carLossRatio: 110, carHandlingFeeRate: 0, carSalesPromotionRate: 0.15, carStandardPremiumRatio: 0.5, motoPremiumRatio: 1.75, motoLossRatio: 4, motoHandlingFeeRate: 66.1, motoSalesPromotionRate: 0.74, motoStandardPremiumRatio: 1.8 }}
            },
            INPUT_SELECTORS: { /* Same as before */
                laborBaseRate: '#laborBaseRate', fixedOperationRate: '#fixedOperationRate', carPremium: '#carPremium', carLossRatio: '#carLossRatio', carHandlingFeeRate: '#carHandlingFeeRate', carSalesPromotionRate: '#carSalesPromotionRate', carStandardPremiumRatio: '#carStandardPremiumRatio', motoPremiumRatio: '#motoPremiumRatio', motoLossRatio: '#motoLossRatio', motoHandlingFeeRate: '#motoHandlingFeeRate', motoSalesPromotionRate: '#motoSalesPromotionRate', motoStandardPremiumRatio: '#motoStandardPremiumRatio',
            },
            CHART_SELECTORS: { /* Same as before */
                combinedAbsolute: '#combinedAbsoluteChart', combinedRate: '#combinedRateChart', carAbsolute: '#carAbsoluteChart', carRate: '#carRateChart', motoAbsolute: '#motoAbsoluteChart', motoRate: '#motoRateChart',
             },
            KPI_SELECTORS: { /* Same as before */
                totalProfit: '#kpiTotalProfit', totalCostRate: '#kpiTotalCostRate', totalPremium: '#kpiTotalPremium', totalEdgeContribution: '#kpiTotalEdgeContribution',
            }
        };

        // --- Utilities ---
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);
        const getInputValue = (id) => parseFloat(DOMElements.inputs[id].value) || 0;
        const getInputValueAsRate = (id) => (parseFloat(DOMElements.inputs[id].value) / 100) || 0;
        const getCssVariable = (varName) => getComputedStyle(DOMElements.html).getPropertyValue(varName).trim();

        // --- DOM Cache, Theme, Drawer, Modal, Scheme, Tabs (mostly same logic as before) ---
        function cacheDOMElements() { /* ... same as before ... */ 
            DOMElements.html = $('html'); DOMElements.themeToggleBtn = $('#themeToggleBtn'); DOMElements.parametersDrawer = $('#parametersDrawer'); DOMElements.openParametersBtn = $('#openParametersBtn'); DOMElements.closeParametersBtn = $('#closeParametersBtn'); DOMElements.drawerBackdrop = $('#drawerBackdrop'); DOMElements.helpModal = $('#indicatorHelpModal'); DOMElements.showHelpBtn = $('#showHelpBtn'); DOMElements.closeHelpModalBtn = $('#closeHelpModalBtn'); DOMElements.schemeSelector = $('#schemeSelector'); DOMElements.exportDataBtn = $('#exportDataBtn'); DOMElements.analysisTabsContainer = $('#analysisTabsContainer');
            DOMElements.inputs = {}; for (const key in APP_CONFIG.INPUT_SELECTORS) DOMElements.inputs[key] = $(APP_CONFIG.INPUT_SELECTORS[key]);
            DOMElements.kpis = {}; for (const key in APP_CONFIG.KPI_SELECTORS) DOMElements.kpis[key] = $(APP_CONFIG.KPI_SELECTORS[key]);
        }
        function applyTheme(theme) { DOMElements.html.classList.remove('theme-light', 'theme-dark'); DOMElements.html.classList.add(`theme-${theme}`); localStorage.setItem(APP_CONFIG.THEME_STORAGE_KEY, theme); updateUI(); }
        function toggleTheme() { const currentTheme = DOMElements.html.classList.contains('theme-dark') ? 'dark' : 'light'; applyTheme(currentTheme === 'dark' ? 'light' : 'dark'); }
        function loadSavedTheme() { const savedTheme = localStorage.getItem(APP_CONFIG.THEME_STORAGE_KEY) || 'dark'; DOMElements.html.classList.remove('theme-light', 'theme-dark'); DOMElements.html.classList.add(`theme-${savedTheme}`); }
        function toggleParametersDrawer(forceOpen) { const isOpen = DOMElements.parametersDrawer.classList.contains('is-open'); const openDrawer = typeof forceOpen === 'boolean' ? forceOpen : !isOpen; if (openDrawer) { DOMElements.parametersDrawer.classList.add('is-open'); DOMElements.drawerBackdrop.classList.add('is-visible'); document.body.style.overflow = 'hidden'; } else { DOMElements.parametersDrawer.classList.remove('is-open'); DOMElements.drawerBackdrop.classList.remove('is-visible'); if (!DOMElements.helpModal.classList.contains('is-visible')) { document.body.style.overflow = ''; } } }
        function toggleHelpModal(show) { if (show) { DOMElements.helpModal.classList.add('is-visible'); document.body.style.overflow = 'hidden'; } else { DOMElements.helpModal.classList.remove('is-visible'); if (!DOMElements.parametersDrawer.classList.contains('is-open')) { document.body.style.overflow = ''; } } }
        function storeCurrentInputValues() { currentInputValues = {}; for (const key in DOMElements.inputs) currentInputValues[key] = DOMElements.inputs[key].value; }
        function highlightChangedParameters() { for (const key in DOMElements.inputs) { const inputElement = DOMElements.inputs[key]; inputElement.classList.remove('form-field__input--highlight'); if (inputElement.value !== currentInputValues[key]) { inputElement.classList.add('form-field__input--highlight'); inputElement.addEventListener('animationend', () => inputElement.classList.remove('form-field__input--highlight'), { once: true }); } } }
        function applyScheme(schemeKey) { storeCurrentInputValues(); const scheme = APP_CONFIG.SCHEMES[schemeKey]; if (!scheme || !scheme.params) return; for (const key in scheme.params) if (DOMElements.inputs[key]) DOMElements.inputs[key].value = scheme.params[key]; updateUI(); toggleParametersDrawer(true); requestAnimationFrame(() => requestAnimationFrame(highlightChangedParameters)); }
        function handleSchemeChange(event) { const targetButton = event.target.closest('.btn'); if (!targetButton || !targetButton.dataset.scheme) return; const schemeKey = targetButton.dataset.scheme; applyScheme(schemeKey); $$('#schemeSelector .btn').forEach(btn => btn.classList.remove('is-active')); targetButton.classList.add('is-active'); }
        function handleAnalysisTabClick(event) { const targetButton = event.target.closest('.analysis-tab-btn'); if (!targetButton || !targetButton.dataset.tab) return; const tabKey = targetButton.dataset.tab; $$('.analysis-tab-btn').forEach(btn => btn.classList.remove('is-active')); $$('.analysis-content').forEach(content => content.classList.remove('is-active')); targetButton.classList.add('is-active'); const activeContent = $(`#analysisContent${tabKey.charAt(0).toUpperCase() + tabKey.slice(1)}`); if (activeContent) activeContent.classList.add('is-active'); ['Absolute', 'Rate'].forEach(type => { const chartKey = `${tabKey}${type}`; if (EChartsInstances[chartKey] && typeof EChartsInstances[chartKey].resize === 'function') setTimeout(() => EChartsInstances[chartKey].resize(), 50); }); }
        function setActiveAnalysisTab(tabKey) { const tabButton = $(`#analysisTabsContainer .analysis-tab-btn[data-tab="${tabKey}"]`); if (tabButton) tabButton.click(); }
        
        // --- KPI Update (Adjusted for 1 decimal place) ---
        function updateKPIs(data) { 
            const formatValue = (v, u, d = 1) => `${parseFloat(v.toFixed(d)).toLocaleString(undefined, {minimumFractionDigits:d, maximumFractionDigits:d})}<span class="unit">${u}</span>`; 
            const p = data.combined.absolute[APP_CONFIG.ABSOLUTE_CHART_INDICATORS.indexOf('PROFIT')]; 
            const cr = data.combined.rate[APP_CONFIG.RATE_CHART_INDICATORS.indexOf('TCR')]; 
            const ec = data.combined.absolute[APP_CONFIG.ABSOLUTE_CHART_INDICATORS.indexOf('EDGE_CONTRIBUTION')]; 
            DOMElements.kpis.totalProfit.innerHTML = formatValue(p, '万元'); 
            DOMElements.kpis.totalProfit.className = `kpi-card__value ${p >= 0 ? 'is-positive' : 'is-negative'}`; 
            DOMElements.kpis.totalCostRate.innerHTML = formatValue(cr * 100, '%'); 
            DOMElements.kpis.totalCostRate.className = `kpi-card__value ${cr <= APP_CONFIG.INDICATOR_CONFIG.TCR.threshold ? 'is-positive' : 'is-negative'}`; 
            DOMElements.kpis.totalPremium.innerHTML = formatValue(data.combined.absolute[APP_CONFIG.ABSOLUTE_CHART_INDICATORS.indexOf('PREMIUM')], '万元'); 
            DOMElements.kpis.totalPremium.className = `kpi-card__value`; 
            DOMElements.kpis.totalEdgeContribution.innerHTML = formatValue(ec, '万元'); 
            DOMElements.kpis.totalEdgeContribution.className = `kpi-card__value ${ec >= 0 ? 'is-positive' : 'is-negative'}`; 
        }

        // --- Calculations --- (Core logic remains the same)
        function getCalculationInputs() { /* ... */ 
            return {
                carPremium: getInputValue('carPremium'), carLossRatio: getInputValueAsRate('carLossRatio'), carHandlingFeeRate: getInputValueAsRate('carHandlingFeeRate'), carSalesPromotionRate: getInputValueAsRate('carSalesPromotionRate'), carStandardPremiumRatio: getInputValue('carStandardPremiumRatio'),
                motoPremiumRatio: getInputValue('motoPremiumRatio'), motoLossRatio: getInputValueAsRate('motoLossRatio'), motoHandlingFeeRate: getInputValueAsRate('motoHandlingFeeRate'), motoSalesPromotionRate: getInputValueAsRate('motoSalesPromotionRate'), motoStandardPremiumRatio: getInputValue('motoStandardPremiumRatio'),
                laborBaseRate: getInputValueAsRate('laborBaseRate'), fixedOperationRate: getInputValueAsRate('fixedOperationRate'),
            };
        }
        function performCalculations(inputs) { /* ... */
             const { carPremium, carLossRatio, carHandlingFeeRate, carSalesPromotionRate, carStandardPremiumRatio, motoPremiumRatio, motoLossRatio, motoHandlingFeeRate, motoSalesPromotionRate, motoStandardPremiumRatio, laborBaseRate, fixedOperationRate } = inputs;
            const carLaborCostRate = carStandardPremiumRatio * laborBaseRate; const carVariableCostRate = carLossRatio + carHandlingFeeRate + carSalesPromotionRate + carLaborCostRate; const carTotalCostRate = carVariableCostRate + fixedOperationRate; const carEdgeContributionRate = 1 - carVariableCostRate; const carLoss = carPremium * carLossRatio; const carHandlingFee = carPremium * carHandlingFeeRate; const carSalesPromotion = carPremium * carSalesPromotionRate; const carLaborCost = carPremium * carLaborCostRate; const carEdgeContribution = carPremium * carEdgeContributionRate; const carProfit = carPremium * (1 - carTotalCostRate);
            const motoPremium = carPremium * motoPremiumRatio; const motoLaborCostRate = motoStandardPremiumRatio * laborBaseRate; const motoVariableCostRate = motoLossRatio + motoHandlingFeeRate + motoSalesPromotionRate + motoLaborCostRate; const motoTotalCostRate = motoVariableCostRate + fixedOperationRate; const motoEdgeContributionRate = 1 - motoVariableCostRate; const motoLoss = motoPremium * motoLossRatio; const motoHandlingFee = motoPremium * motoHandlingFeeRate; const motoSalesPromotion = motoPremium * motoSalesPromotionRate; const motoLaborCost = motoPremium * motoLaborCostRate; const motoEdgeContribution = motoPremium * motoEdgeContributionRate; const motoProfit = motoPremium * (1 - motoTotalCostRate);
            const totalPremium = carPremium + motoPremium; const totalLoss = carLoss + motoLoss; const totalHandlingFee = carHandlingFee + motoHandlingFee; const totalSalesPromotion = carSalesPromotion + motoSalesPromotion; const totalLaborCost = carLaborCost + motoLaborCost; const totalVariableCost = totalLoss + totalHandlingFee + totalSalesPromotion + totalLaborCost; const totalVariableCostRate = totalPremium > 0 ? totalVariableCost / totalPremium : 0; const totalCostRate = totalVariableCostRate + fixedOperationRate; const totalEdgeContribution = carEdgeContribution + motoEdgeContribution; const totalProfit = carProfit + motoProfit; const totalEdgeContributionRate = 1 - totalVariableCostRate;
            return { car: { absolute: [carPremium, carLoss, carHandlingFee, carSalesPromotion, carLaborCost, carEdgeContribution, carProfit], rate: [carTotalCostRate, carVariableCostRate, carLossRatio, carHandlingFeeRate, carSalesPromotionRate, carLaborCostRate, carEdgeContributionRate] }, moto: { absolute: [motoPremium, motoLoss, motoHandlingFee, motoSalesPromotion, motoLaborCost, motoEdgeContribution, motoProfit], rate: [motoTotalCostRate, motoVariableCostRate, motoLossRatio, motoHandlingFeeRate, motoSalesPromotionRate, motoLaborCostRate, motoEdgeContributionRate] }, combined: { absolute: [totalPremium, totalLoss, totalHandlingFee, totalSalesPromotion, totalLaborCost, totalEdgeContribution, totalProfit], rate: [totalCostRate, totalVariableCostRate, totalPremium > 0 ? totalLoss/totalPremium : 0, totalPremium > 0 ? totalHandlingFee/totalPremium : 0, totalPremium > 0 ? totalSalesPromotion/totalPremium : 0, totalPremium > 0 ? totalLaborCost/totalPremium : 0, totalEdgeContributionRate] } };
        }

        // --- ECharts Theming & Configuration (Adjusted for 1 decimal, new titles, removed Y-axis) ---
        function getChartThemeOptions() {
            const isDark = DOMElements.html.classList.contains('theme-dark');
            const cssVar = (name) => getCssVariable(name);

            return {
                isDark, colorPositive: cssVar('--color-positive'), colorNegative: cssVar('--color-negative'), colorNeutral: cssVar('--color-neutral'), colorAccent: cssVar('--color-accent'),
                textColorPrimary: cssVar('--color-text-primary'), textColorSecondary: cssVar('--color-text-secondary'), borderColor: cssVar('--color-border'),
                title: { left: 'center', top: '5%', textStyle: { color: cssVar('--color-text-primary'), fontSize: 18, fontWeight: cssVar('--font-weight-semibold'), fontFamily: cssVar('--font-family-sans'), } }, // Slightly larger title
                grid: { left: '3%', right: '5%', bottom: '20%', top: '20%', containLabel: true }, // Adjusted bottom/top for larger X-axis labels and title
                textStyle: { fontFamily: cssVar('--font-family-sans'), color: cssVar('--color-text-secondary'), fontSize: parseFloat(cssVar('--font-size-chart-xaxis')) }, // Base text style for chart
                tooltip: {
                    trigger: 'axis', axisPointer: { type: 'shadow' },
                    backgroundColor: cssVar(isDark ? '--color-background-elevated' : '--color-background-content'),
                    borderColor: cssVar('--color-border'),
                    textStyle: { color: cssVar('--color-text-primary') },
                    confine: true,
                    valueFormatter: (value) => value != null ? parseFloat(value).toFixed(1) : 'N/A' // Tooltip value 1 decimal
                },
                xAxis: {
                    type: 'category',
                    axisLine: { show: true, lineStyle: { color: cssVar('--color-border'), width: 1 } },
                    axisTick: { show: false },
                    axisLabel: { 
                        color: cssVar('--color-text-secondary'), 
                        fontSize: parseFloat(cssVar('--font-size-chart-xaxis')),
                        interval: 0, rotate: 0,
                        fontWeight: cssVar('--font-weight-semibold') // Bolder X-axis labels
                    }
                },
                yAxis: { show: false }, // Y-axis removed
                seriesBase: {
                    type: 'bar', barWidth: '70%', barGap: '-50%',
                    itemStyle: { borderRadius: [5, 5, 0, 0] },
                    label: {
                        show: true, position: 'top',
                        fontFamily: cssVar('--font-family-sans'),
                        fontSize: parseFloat(cssVar('--font-size-chart-xaxis')),
                        fontWeight: cssVar('--font-weight-bold'),
                        distance: 8,
                        padding: [5, 5, 5, 5], // 增加内边距
                        formatter: (params) => parseFloat(params.value).toFixed(1) // Data label 1 decimal
                    }
                },
                colorPalette: isDark
                    ? [cssVar('--color-accent'), '#5e5ce6', '#64d2ff', '#ff9f0a', '#bf5af2', '#30d15b', '#ff453a']
                    : [cssVar('--color-accent'), '#5856d6', '#5ac8fa', '#ff9500', '#af52de', '#34c759', '#dc3545']
            };
        }
        function determineColor(value, config, themeOpts) { /* ... same as before ... */ 
             if (config.colorKey === 'conditional') { if (config.isRate && config.higherIsWorse) { return value > config.threshold ? themeOpts.colorNegative : themeOpts.colorPositive; } else if (config.positiveGood) { return value >= 0 ? themeOpts.colorPositive : themeOpts.colorNegative; } } return config.colorKey === 'neutral' ? themeOpts.colorNeutral : themeOpts.colorAccent;
        }

        function createAbsoluteChartOption(data, chartTitle, unit = '万元') {
            const themeOpts = getChartThemeOptions();
            const indicators = APP_CONFIG.ABSOLUTE_CHART_INDICATORS;
            const xAxisData = indicators.map(key => APP_CONFIG.INDICATOR_CONFIG[key].label);

            const seriesData = data.map((value, index) => {
                const indicatorKey = indicators[index];
                const config = APP_CONFIG.INDICATOR_CONFIG[indicatorKey];
                const val = parseFloat(value.toFixed(1)); // Store with 1 decimal for consistency
                
                let itemColor = determineColor(val, config, themeOpts);
                if ((itemColor === themeOpts.colorNeutral && config.colorKey !== 'neutral') || (itemColor === themeOpts.colorAccent && config.colorKey !== 'accent' && config.colorKey !== 'conditional')) {
                    itemColor = themeOpts.colorPalette[index % themeOpts.colorPalette.length];
                }
                let labelColor = itemColor;

                return {
                    value: val, itemStyle: { ...themeOpts.seriesBase.itemStyle, color: itemColor },
                    label: { 
                        ...themeOpts.seriesBase.label, 
                        color: labelColor, 
                        position: val < 0 ? 'bottom' : 'top', 
                        distance: val < 0 ? 15 : 8, // 增加负值标签的距离
                        padding: [5, 5, 5, 5] // 增加内边距
                    }
                };
            });

            return {
                title: { ...themeOpts.title, text: chartTitle },
                grid: themeOpts.grid, textStyle: themeOpts.textStyle, tooltip: { ...themeOpts.tooltip, valueFormatter: value => `${value != null ? parseFloat(value).toFixed(1) : 'N/A'} ${unit}` },
                xAxis: { ...themeOpts.xAxis, data: xAxisData, axisLabel: {...themeOpts.xAxis.axisLabel, color: (value, index) => seriesData[index].label.color } },
                yAxis: themeOpts.yAxis, 
                series: [{ ...themeOpts.seriesBase, data: seriesData }]
            };
        }

        function createRateChartOption(data, chartTitle) {
            const themeOpts = getChartThemeOptions();
            const indicators = APP_CONFIG.RATE_CHART_INDICATORS;
            const xAxisData = indicators.map(key => APP_CONFIG.INDICATOR_CONFIG[key].label);

            const seriesData = data.map((value, index) => {
                const indicatorKey = indicators[index];
                const config = APP_CONFIG.INDICATOR_CONFIG[indicatorKey];
                const valPct = parseFloat((value * 100).toFixed(1)); // Store with 1 decimal
                
                let itemColor = determineColor(value, config, themeOpts);
                if ((itemColor === themeOpts.colorNeutral && config.colorKey !== 'neutral') || (itemColor === themeOpts.colorAccent && config.colorKey !== 'accent' && config.colorKey !== 'conditional')) {
                    itemColor = themeOpts.colorPalette[index % themeOpts.colorPalette.length];
                }
                let labelColor = itemColor;

                return {
                    value: valPct, itemStyle: { ...themeOpts.seriesBase.itemStyle, color: itemColor },
                    label: {
                        ...themeOpts.seriesBase.label,
                        color: labelColor,
                        position: valPct < 0 && config.positiveGood ? 'bottom' : 'top',
                        distance: valPct < 0 && config.positiveGood ? 15 : 8, // 增加负值标签的距离
                        formatter: (params) => `${parseFloat(params.value).toFixed(1)}%`,
                        padding: [5, 5, 5, 5] // 增加内边距
                    }
                };
            });
            
            return {
                title: { ...themeOpts.title, text: chartTitle },
                grid: themeOpts.grid, textStyle: themeOpts.textStyle, tooltip: { ...themeOpts.tooltip, valueFormatter: value => `${value != null ? parseFloat(value).toFixed(1) : 'N/A'}%` },
                xAxis: { ...themeOpts.xAxis, data: xAxisData, axisLabel: {...themeOpts.xAxis.axisLabel, color: (value, index) => seriesData[index].label.color } },
                yAxis: themeOpts.yAxis,
                series: [{ ...themeOpts.seriesBase, data: seriesData }]
            };
        }
        
        function initCharts() { /* ... same as before ... */ 
            for (const key in APP_CONFIG.CHART_SELECTORS) { const chartDom = $(APP_CONFIG.CHART_SELECTORS[key]); if (chartDom) EChartsInstances[key] = echarts.init(chartDom); }
        }
        function updateAllCharts(data) { /* ... same as before, but pass chart titles ... */
            const setOpt = (key, optionFn, dataArg, title) => { if (EChartsInstances[key] && typeof EChartsInstances[key].setOption === 'function') { EChartsInstances[key].clear(); EChartsInstances[key].setOption(optionFn(dataArg, title), true); } else { console.warn(`Chart instance for ${key} is not available.`); } };
            setOpt('carAbsolute', createAbsoluteChartOption, data.car.absolute, '关键指标金额 (万元)'); setOpt('carRate', createRateChartOption, data.car.rate, '核心效能比率 (%)'); 
            setOpt('motoAbsolute', createAbsoluteChartOption, data.moto.absolute, '关键指标金额 (万元)'); setOpt('motoRate', createRateChartOption, data.moto.rate, '核心效能比率 (%)'); 
            setOpt('combinedAbsolute', createAbsoluteChartOption, data.combined.absolute, '关键指标金额 (万元)'); setOpt('combinedRate', createRateChartOption, data.combined.rate, '核心效能比率 (%)');
        }

        // --- Data Export ---
        function exportDataToCSV() { /* ... Adjusted for 1 decimal place ... */
            const inputs = getCalculationInputs(); const data = performCalculations(inputs); let csvContent = '\ufeff'; csvContent += '车+摩意险成本测算结果汇总表\n\n'; csvContent += '指标分类,车险,摩意险,合计\n';
            const indicatorMap = [ { name: '保费(万元)', absoluteIndex: 0 }, { name: '赔款(万元)', absoluteIndex: 1 }, { name: '手续费(万元)', absoluteIndex: 2 }, { name: '销推费用(万元)', absoluteIndex: 3 }, { name: '人力成本(万元)', absoluteIndex: 4 }, { name: '边际贡献额(万元)', absoluteIndex: 5 }, { name: '利润(万元)', absoluteIndex: 6 }, { name: '综合成本率(%)', rateIndex: 0, isPercent: true }, { name: '变动成本率(%)', rateIndex: 1, isPercent: true }, { name: '赔付率(%)', rateIndex: 2, isPercent: true }, { name: '边际贡献率(%)', rateIndex: 6, isPercent: true } ];
            function getValue(sectionData, indicator) { 
                if (indicator.absoluteIndex !== undefined) return sectionData.absolute[indicator.absoluteIndex].toFixed(1); 
                if (indicator.rateIndex !== undefined) { const rateArray = sectionData === data.combined.rate ? sectionData : sectionData.rate; return (rateArray[indicator.rateIndex] * 100).toFixed(1); } return ''; 
            }
            indicatorMap.forEach(indicator => { const row = [indicator.name, getValue(data.car, indicator), getValue(data.moto, indicator), getValue(indicator.isPercent ? data.combined.rate : data.combined, indicator)]; csvContent += row.join(',') + '\n'; });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = '成本洞察Pro_测算结果.csv'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // --- Core Update Cycle & Event Listeners (mostly same) ---
        function updateUI() { const inputs = getCalculationInputs(); const calculatedData = performCalculations(inputs); updateKPIs(calculatedData); updateAllCharts(calculatedData); }
        function bindEventListeners() { DOMElements.themeToggleBtn.addEventListener('click', toggleTheme); DOMElements.openParametersBtn.addEventListener('click', () => toggleParametersDrawer(true)); DOMElements.closeParametersBtn.addEventListener('click', () => toggleParametersDrawer(false)); DOMElements.drawerBackdrop.addEventListener('click', () => toggleParametersDrawer(false)); DOMElements.showHelpBtn.addEventListener('click', () => toggleHelpModal(true)); DOMElements.closeHelpModalBtn.addEventListener('click', () => toggleHelpModal(false)); DOMElements.helpModal.addEventListener('click', (e) => { if (e.target === DOMElements.helpModal) toggleHelpModal(false); }); DOMElements.schemeSelector.addEventListener('click', handleSchemeChange); DOMElements.exportDataBtn.addEventListener('click', exportDataToCSV); DOMElements.analysisTabsContainer.addEventListener('click', handleAnalysisTabClick); for (const key in DOMElements.inputs) { DOMElements.inputs[key].addEventListener('focus', storeCurrentInputValues); DOMElements.inputs[key].addEventListener('input', updateUI); DOMElements.inputs[key].addEventListener('change', () => { highlightChangedParameters(); updateUI(); }); } window.addEventListener('resize', () => { for (const key in EChartsInstances) if (EChartsInstances[key] && typeof EChartsInstances[key].resize === 'function') EChartsInstances[key].resize(); }); }
        
        // --- Initialization ---
        function init() { cacheDOMElements(); loadSavedTheme(); initCharts(); bindEventListeners(); storeCurrentInputValues(); applyScheme(DEFAULT_SCHEME_KEY); const defaultSchemeBtn = $(`#schemeSelector .btn[data-scheme="${DEFAULT_SCHEME_KEY}"]`); if (defaultSchemeBtn) defaultSchemeBtn.classList.add('is-active'); setActiveAnalysisTab(DEFAULT_ANALYSIS_TAB); }
        return { init };
    })();
    document.addEventListener('DOMContentLoaded', CostInsightPro.init);
    </script>
</body>
</html>